<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>CineMatch ‚Äî Chat / Upload UI</title>

    <style>

        /*************************************
         GLOBAL (DEFAULT = DARK MODE)
        **************************************/
        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background: #0f172a;      /* DARK MODE DEFAULT */
            color: #e5e7eb;
            font-family: system-ui, sans-serif;
            transition: background 0.25s, color 0.25s;
        }

        /*************************************
         LIGHT MODE  (ŒºŒµ Œ∫ŒªŒ¨œÉŒ∑ .dark-mode œåœÄœâœÇ œÉœÑŒ± Œ¨ŒªŒªŒ± pages)
        **************************************/
        body.dark-mode {
            background: #ffffff;
            color: #0f172a;
        }

        /*************************************
         HEADER
        **************************************/
        .header {
            backdrop-filter: blur(14px);
            background: rgba(15,23,42,0.75);
            padding: 24px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(148,163,184,0.2);
            transition: background 0.25s;
        }

        body.dark-mode .header {
            background: rgba(255,255,255,0.75);
            border-bottom-color: rgba(0,0,0,0.25);
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, #f97316, #ec4899);
            -webkit-background-clip: text;
            color: transparent;
            cursor: pointer;
        }

        body.dark-mode .logo {
            -webkit-background-clip: unset;
            color: #1e293b;
        }

        .nav-btns {
            display: flex;
            gap: 14px;
        }

        .nav-btn {
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #f97316, #ec4899);
            color: white;
            font-weight: 600;
            transition: transform 0.2s linear, opacity 0.2s;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

         /* ‚úÖ COMBINED USER BUTTON (PROFILE + LOGOUT) */
        .user-combo {
            display: flex;
            border-radius: 999px;
            overflow: hidden;
            background: linear-gradient(135deg, #f97316, #ec4899);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }

        /* ŒöŒøŒπŒΩœå styling Œ∫Œ±Œπ Œ≥ŒπŒ± œÑŒ± 2 */
        .user-combo button {
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            color: white;
            background: transparent;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.15s ease;
        }

        /* ‚úÖ ŒìŒ°ŒëŒúŒúŒüŒ•ŒõŒë ŒëŒùŒëŒúŒïŒ£Œë */
        .user-left {
            border-right: 1px solid rgba(255,255,255,0.4);
        }

        /* ‚úÖ ŒöŒëŒõŒ•Œ§ŒïŒ°Œü HOVER */
        .user-combo button:hover {
            background: rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }

        /* ‚úÖ Œ†ŒôŒü ‚ÄúŒöŒõŒôŒö-FEEL‚Äù Œ£Œ§Œü LOGOUT */
        .user-right:hover {
            background: rgba(0,0,0,0.35);
        }

        /*************************************
         CHAT CONTAINER
        **************************************/
        .chat-container {
            width: 90%;
            max-width: 900px;

            height: calc(100vh - 180px);
            margin: 30px auto;

            background: rgba(15,23,42,0.85);
            border-radius: 12px;

            display: flex;
            flex-direction: column;
            overflow: hidden;

            transition: background 0.25s;
        }

        body.dark-mode .chat-container {
            background: #f3f4f6;
        }

        /*************************************
         MESSAGES
        **************************************/
        #messages {
            flex: 1;
            padding: 60px 16px 16px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message-wrapper {
            display: flex;
            gap: 10px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            background: rgba(255,255,255,0.1);
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
        }

        .message.me {
            background: linear-gradient(135deg, #f97316, #ec4899);
            color: white;
        }

        body.dark-mode .message {
            background: #e5e7eb;
            color: #111827;
        }

        body.dark-mode .message.me {
            background: #ffe0b5;
            color: #111827;
        }

        .header-info {
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        /*************************************
         INPUT AREA
        **************************************/
        .input-area {
            padding: 18px 20px;
            background: rgba(15,23,42,0.95);
            border-top: 1px solid rgba(148,163,184,0.2);

            display: flex;
            flex-direction: column;
            gap: 12px;

            transition: background 0.25s;
        }

        body.dark-mode .input-area {
            background: #ffffff;
        }

        .text-files {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .text-files input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            font-size: 16px;
            border-radius: 14px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(30,41,59,0.9);
            color: #e5e7eb;
        }

        body.dark-mode .text-files input[type="text"] {
            background: #ffffff;
            color: #111827;
            border-color: rgba(148,163,184,0.6);
        }

        .send-btn {
            width: 180px;
            padding: 12px 20px;
            border: none;
            border-radius: 999px;

            background: linear-gradient(135deg, #f97316, #ec4899);
            color: white;
            font-weight: 600;

            cursor: pointer;
            align-self: flex-end;
            transition: transform 0.2s, opacity 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

    </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <div class="logo" onclick="window.location.href='/'">CineMatch</div>

    <div class="nav-btns">

        <a class="nav-btn" href="/trending">Trending</a>
        <button class="nav-btn" onclick="window.location.href='/trending-celebrities'">Trending Actors</button>
        <a class="nav-btn" href="/upload">Upload</a>
        <button class="nav-btn" onclick="window.location.href='/actor-match'">Actor Match</button>
        <button class="nav-btn" onclick="window.location.href='/sentiment'">Sentiment Search</button>
        <a class="nav-btn" href="/quiz-selection">Quiz</a>
        <button class="nav-btn" onclick="toggleDarkMode()">DarkMode</button>

        <button class="nav-btn" onclick="location.href='/history'">History</button>

        <!-- üî• NOT LOGGED IN -->
        <th:block th:if="${loggedUser == null}">
            <button class="nav-btn" onclick="window.location.href='/login'">
                LogIn / SignUp
            </button>
        </th:block>

        <!-- ‚úÖ LOGGED IN -->
        <th:block th:if="${loggedUser != null}">
            <div class="user-combo">

                <button class="user-left"
                        onclick="window.location.href='/profile'">
                    <span th:text="${loggedUser.fullName}">User</span>
                </button>

                <button class="user-right"
                        onclick="window.location.href='/logout'">
                    Logout
                </button>

            </div>
        </th:block>

    </div>
</div>

<!-- CHAT -->
<div class="chat-container">
    <div id="messages"></div>

    <div class="input-area">
        <div class="text-files">
            <input type="text" id="msgInput" placeholder="Type a message...">
            <input type="file" id="fileInput" accept="image/*,video/*" multiple>
        </div>

        <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
</div>


<div id="loggedUserId" th:data-id="${loggedUser != null ? loggedUser.id : -1}"></div>
<script>

    function toggleDarkMode() {
        const body = document.body;
        const isDark = body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", isDark);
    }

    window.onload = () => {
        if (localStorage.getItem("darkMode") === "true") {
            document.body.classList.add("dark-mode");
        }
    };


    /***********************
      SEND MESSAGE
    ************************/
    async function sendMessage() {
        const text = msgInput.value.trim();
        const files = fileInput.files;

        if (!text && files.length === 0) return;

        const formData = new FormData();
        formData.append("message", text);

        for (let file of files) {
            formData.append("files", file);
        }

        try {
            const res = await fetch("/api/uploads", {
                method: "POST",
                body: formData
            });

            if (!res.ok) {
                alert("Upload failed");
                return;
            }

            const savedUpload = await res.json();

            addMessage({
                username: savedUpload.user.fullName,
                text: savedUpload.message,
                createdAt: savedUpload.createdAt,
                media: savedUpload.filePath ? [{
                    url: "/uploads/" + savedUpload.filePath,
                    type: savedUpload.fileType
                }] : []
            }, "me");

            msgInput.value = "";
            fileInput.value = "";

        } catch (err) {
            console.error("UPLOAD ERROR:", err);
        }
    }



    /***********************
      ADD MESSAGE TO CHAT
    ************************/
    function addMessage({ username, text, createdAt, media = [] }, who) {
        const container = document.getElementById("messages");

        const wrapper = document.createElement("div");
        wrapper.className = "message-wrapper " + who;

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.innerHTML = `
            <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z"/>
            </svg>
        `;

        const msg = document.createElement("div");
        msg.className = "message " + who;

        msg.innerHTML = `
            <div class="header-info">
                <span>${username}</span>
                <span>${createdAt ? new Date(createdAt).toLocaleTimeString() : new Date().toLocaleTimeString()}</span>
            </div>
            ${text ? `<div>${text}</div>` : ""}
        `;

        if (media.length > 0) {
            const mediaContainer = document.createElement("div");
            mediaContainer.style.marginTop = "8px";
            mediaContainer.style.display = "flex";
            mediaContainer.style.flexWrap = "wrap";
            mediaContainer.style.gap = "10px";

            media.forEach(m => {
                if (m.type?.startsWith("image/")) {
                    const img = document.createElement("img");
                    img.src = m.url;
                    img.style.width = "160px";
                    img.style.borderRadius = "8px";
                    mediaContainer.appendChild(img);
                }

                if (m.type?.startsWith("video/")) {
                    const video = document.createElement("video");
                    video.src = m.url;
                    video.controls = true;
                    video.style.width = "200px";
                    video.style.borderRadius = "8px";
                    mediaContainer.appendChild(video);
                }
            });

            msg.appendChild(mediaContainer);
        }

        wrapper.appendChild(avatar);
        wrapper.appendChild(msg);
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
    }


    /***********************
      LOAD OLD UPLOADS
    ************************/
    fetch("/api/uploads")
        .then(res => res.json())
        .then(data => {

            const loggedUserId = parseInt(
                document.getElementById("loggedUserId").dataset.id
            );

            data.reverse().forEach(upload => {
                const who = (upload.user.id === loggedUserId) ? "me" : "other";

                addMessage({
                    username: upload.user.fullName,
                    text: upload.message,
                    createdAt: upload.createdAt,
                    media: upload.filePath ? [{
                        url: "/uploads/" + upload.filePath,
                        type: upload.fileType
                    }] : []
                }, who);
            });
        });

    // BOT
    addMessage(
        { username: "CineMatch Bot", text: "Welcome to the chat! Upload something or send a message." },
        "other"
    );

</script>

</body>
</html>
